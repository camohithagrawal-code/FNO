<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="F&O Scanner">
    <meta name="theme-color" content="#0a0e27">
    <title>NSE F&O Scanner - Angel SmartAPI</title>
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%2300ff88' width='100' height='100'/><text y='75' font-size='70' fill='%230a0e27'>üìä</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif; background: #0a0e27; color: #e1e4e8; overflow-x: hidden; -webkit-font-smoothing: antialiased; padding-bottom: env(safe-area-inset-bottom); }
        .mobile-header { position: sticky; top: 0; background: linear-gradient(135deg, #1a1f3a 0%, #2d3561 100%); padding: max(env(safe-area-inset-top), 15px) 15px 15px 15px; z-index: 1000; box-shadow: 0 2px 20px rgba(0,0,0,0.3); }
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .app-title { font-size: 20px; font-weight: 700; color: #00ff88; display: flex; align-items: center; gap: 8px; }
        .status-badge { display: flex; gap: 8px; align-items: center; }
        .badge { padding: 5px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; display: flex; align-items: center; gap: 5px; }
        .badge-live { background: rgba(0,255,136,0.2); color: #00ff88; }
        .badge-vix { background: rgba(255,165,2,0.2); color: #ffa502; }
        .badge-error { background: rgba(255,71,87,0.2); color: #ff4757; }
        .pulse-dot { width: 6px; height: 6px; background: #00ff88; border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.3); } }
        .quick-actions { display: flex; gap: 8px; overflow-x: auto; padding: 8px 0; -webkit-overflow-scrolling: touch; }
        .quick-actions::-webkit-scrollbar { display: none; }
        .action-btn { padding: 8px 15px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; color: #e1e4e8; font-size: 13px; font-weight: 600; white-space: nowrap; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 6px; }
        .action-btn.active { background: linear-gradient(135deg, #00ff88 0%, #00d4ff 100%); color: #0a0e27; border-color: transparent; }
        .action-btn:active { transform: scale(0.95); }
        .stats-strip { background: rgba(0,0,0,0.2); padding: 12px 15px; display: flex; gap: 12px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .stats-strip::-webkit-scrollbar { display: none; }
        .stat-mini { display: flex; flex-direction: column; align-items: center; min-width: 70px; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 10px; }
        .stat-mini-value { font-size: 18px; font-weight: 700; margin-bottom: 3px; }
        .stat-mini-label { font-size: 10px; color: #8b92a8; text-transform: uppercase; }
        .stocks-container { padding: 15px; padding-bottom: 80px; }
        .stock-card { background: rgba(255,255,255,0.03); border-radius: 15px; padding: 15px; margin-bottom: 12px; border-left: 4px solid #00ff88; }
        .stock-card.seller-friendly { border-left-color: #00ff88; background: rgba(0,255,136,0.05); }
        .stock-card.caution { border-left-color: #ffa502; background: rgba(255,165,2,0.05); }
        .stock-card.avoid { border-left-color: #ff4757; background: rgba(255,71,87,0.05); }
        .stock-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .stock-name-mobile { font-size: 18px; font-weight: 700; color: #00d4ff; }
        .stock-price-mobile { font-size: 16px; font-weight: 600; }
        .price-change { font-size: 13px; margin-top: 2px; }
        .positive { color: #00ff88; }
        .negative { color: #ff4757; }
        .metrics-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 12px; }
        .metric-box { text-align: center; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 8px; }
        .metric-box-value { font-size: 15px; font-weight: 700; margin-bottom: 3px; }
        .metric-box-label { font-size: 10px; color: #8b92a8; text-transform: uppercase; }
        .oi-badge-mobile { padding: 6px 12px; border-radius: 15px; font-size: 11px; font-weight: 600; text-transform: uppercase; display: inline-block; margin-bottom: 12px; }
        .long-buildup { background: rgba(0,255,136,0.2); color: #00ff88; }
        .short-buildup { background: rgba(255,71,87,0.2); color: #ff4757; }
        .short-covering { background: rgba(0,212,255,0.2); color: #00d4ff; }
        .long-unwinding { background: rgba(255,165,2,0.2); color: #ffa502; }
        .trade-info { background: rgba(0,0,0,0.3); padding: 12px; border-radius: 10px; }
        .trade-row-mobile { display: flex; justify-content: space-between; padding: 6px 0; font-size: 13px; }
        .trade-label-mobile { color: #8b92a8; }
        .trade-value-mobile { font-weight: 700; }
        .highlight-value { font-size: 16px; color: #00ff88; }
        .ivp-indicator { height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; margin-top: 4px; }
        .ivp-fill { height: 100%; background: linear-gradient(90deg, #00ff88 0%, #ffa502 50%, #ff4757 100%); transition: width 0.3s; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: #1a1f3a; border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-around; padding: 8px 0 max(8px, env(safe-area-inset-bottom)); z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 8px 15px; cursor: pointer; color: #8b92a8; font-size: 11px; font-weight: 600; transition: color 0.3s; position: relative; }
        .nav-item.active { color: #00ff88; }
        .nav-icon { font-size: 22px; }
        .loading-mobile { display: none; text-align: center; padding: 40px 20px; }
        .loading-mobile.show { display: block; }
        .spinner-mobile { width: 40px; height: 40px; border: 3px solid rgba(0,255,136,0.2); border-top-color: #00ff88; border-radius: 50%; margin: 0 auto 15px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .refresh-btn { position: fixed; bottom: 80px; right: 15px; width: 56px; height: 56px; background: linear-gradient(135deg, #00ff88 0%, #00d4ff 100%); border-radius: 50%; border: none; color: #0a0e27; font-size: 24px; cursor: pointer; box-shadow: 0 4px 20px rgba(0,255,136,0.4); z-index: 999; display: flex; align-items: center; justify-content: center; transition: transform 0.3s; }
        .refresh-btn:active { transform: scale(0.9) rotate(180deg); }
        .filter-sheet { position: fixed; bottom: 0; left: 0; right: 0; background: #1a1f3a; border-radius: 20px 20px 0 0; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 2000; max-height: 80vh; overflow-y: auto; padding-bottom: env(safe-area-inset-bottom); }
        .filter-sheet.show { transform: translateY(0); }
        .sheet-handle { width: 40px; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; margin: 12px auto 15px; }
        .sheet-header { padding: 0 20px 15px; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 18px; font-weight: 700; color: #00ff88; }
        .filter-group-mobile { padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .filter-label-mobile { font-size: 13px; color: #8b92a8; margin-bottom: 8px; display: flex; justify-content: space-between; }
        .filter-input-mobile { width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: #e1e4e8; font-size: 16px; }
        .filter-input-mobile:focus { outline: none; border-color: #00ff88; }
        .toggle-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .toggle-switch-mobile { position: relative; width: 50px; height: 30px; background: rgba(255,255,255,0.1); border-radius: 15px; cursor: pointer; transition: background 0.3s; }
        .toggle-switch-mobile.active { background: #00ff88; }
        .toggle-slider-mobile { position: absolute; top: 3px; left: 3px; width: 24px; height: 24px; background: white; border-radius: 50%; transition: transform 0.3s; }
        .toggle-switch-mobile.active .toggle-slider-mobile { transform: translateX(20px); }
        .apply-filters-btn { margin: 20px; padding: 15px; background: linear-gradient(135deg, #00ff88 0%, #00d4ff 100%); color: #0a0e27; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; width: calc(100% - 40px); cursor: pointer; }
        .apply-filters-btn:active { transform: scale(0.98); }
        .alerts-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 3000; padding: 20px; overflow-y: auto; }
        .alerts-modal.show { display: block; }
        .modal-header-mobile { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-top: env(safe-area-inset-top); }
        .modal-title { font-size: 22px; font-weight: 700; color: #00ff88; }
        .close-btn { font-size: 30px; color: #8b92a8; cursor: pointer; }
        .alert-card { background: rgba(255,255,255,0.05); border-left: 3px solid #ff4757; border-radius: 10px; padding: 15px; margin-bottom: 12px; }
        .alert-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .alert-stock { font-size: 16px; font-weight: 700; color: #00d4ff; }
        .alert-badge-small { padding: 4px 10px; background: rgba(255,71,87,0.2); color: #ff4757; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .alert-message { font-size: 14px; color: #e1e4e8; }
        .empty-state { text-align: center; padding: 60px 20px; color: #8b92a8; }
        .empty-icon { font-size: 48px; margin-bottom: 15px; }
        .alert-badge-nav { position: absolute; top: 4px; right: 8px; background: #ff4757; color: white; border-radius: 10px; padding: 2px 6px; font-size: 10px; font-weight: 700; }
        .error-banner { background: rgba(255,71,87,0.2); color: #ff4757; padding: 12px 15px; text-align: center; font-size: 13px; border-bottom: 1px solid rgba(255,71,87,0.3); }
        .success-banner { background: rgba(0,255,136,0.2); color: #00ff88; padding: 12px 15px; text-align: center; font-size: 13px; border-bottom: 1px solid rgba(0,255,136,0.3); }
        .config-panel { padding: 20px; display: none; }
        .config-panel.show { display: block; }
        .config-input { width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e1e4e8; font-size: 14px; margin-bottom: 15px; }
        .config-label { font-size: 13px; color: #8b92a8; margin-bottom: 8px; font-weight: 600; display: block; }
        .save-config-btn { padding: 12px 20px; background: linear-gradient(135deg, #00ff88 0%, #00d4ff 100%); color: #0a0e27; border: none; border-radius: 8px; font-size: 14px; font-weight: 700; cursor: pointer; width: 100%; margin-bottom: 10px; }
        .test-connection-btn { padding: 12px 20px; background: rgba(0,212,255,0.2); color: #00d4ff; border: 1px solid #00d4ff; border-radius: 8px; font-size: 14px; font-weight: 700; cursor: pointer; width: 100%; }
        .data-source-info { background: rgba(0,212,255,0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 3px solid #00d4ff; }
        .setup-guide { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 10px; margin-top: 20px; font-size: 12px; line-height: 1.6; }
        .setup-guide h4 { color: #00ff88; margin-bottom: 10px; }
        .setup-guide ol { margin-left: 20px; }
        .setup-guide li { margin-bottom: 8px; }
        .last-update { font-size: 11px; color: #8b92a8; text-align: center; padding: 10px; }
        @media (max-width: 375px) { .metrics-row { grid-template-columns: repeat(2, 1fr); } }
    </style>
</head>
<body>
    <div id="bannerContainer"></div>
    
    <div class="mobile-header">
        <div class="header-row">
            <div class="app-title">üìä F&O Scanner <span style="font-size: 10px; opacity: 0.7;">Angel API</span></div>
            <div class="status-badge">
                <div class="badge badge-live" id="connectionBadge">
                    <div class="pulse-dot"></div>
                    <span id="marketStatus">NOT CONFIGURED</span>
                </div>
                <div class="badge badge-vix">VIX <span id="vixValue">--</span></div>
            </div>
        </div>
        <div class="quick-actions">
            <button class="action-btn active" onclick="setFilter('all')">All (<span id="countAll">0</span>)</button>
            <button class="action-btn" onclick="setFilter('seller')">üü¢ Seller (<span id="countSeller">0</span>)</button>
            <button class="action-btn" onclick="setFilter('caution')">üü° Caution (<span id="countCaution">0</span>)</button>
            <button class="action-btn" onclick="setFilter('avoid')">üî¥ Avoid (<span id="countAvoid">0</span>)</button>
        </div>
    </div>
    
    <div class="stats-strip">
        <div class="stat-mini"><div class="stat-mini-value" id="statNifty">--</div><div class="stat-mini-label">Nifty</div></div>
        <div class="stat-mini"><div class="stat-mini-value" id="statStocks">0</div><div class="stat-mini-label">Stocks</div></div>
        <div class="stat-mini"><div class="stat-mini-value" id="statAvgROC">0%</div><div class="stat-mini-label">Avg ROC</div></div>
        <div class="stat-mini"><div class="stat-mini-value" id="statHighIVP">0</div><div class="stat-mini-label">High IVP</div></div>
    </div>
    
    <div class="stocks-container" id="stocksContainer">
        <div class="empty-state">
            <div class="empty-icon">üîß</div>
            <h3>Angel SmartAPI Not Configured</h3>
            <p>Please go to API tab and enter your credentials</p>
            <button class="save-config-btn" style="max-width: 200px; margin: 20px auto;" onclick="showTab('config')">Configure Now</button>
        </div>
    </div>
    
    <button class="refresh-btn" onclick="refreshData()" title="Refresh Data">üîÑ</button>
    
    <div class="filter-sheet" id="filterSheet">
        <div class="sheet-handle"></div>
        <div class="sheet-header">Filter Settings</div>
        <div class="filter-group-mobile"><div class="filter-label-mobile"><span>Min IVP (%)</span><span id="ivpValue">75</span></div><input type="range" class="filter-input-mobile" id="filterIVP" min="0" max="100" value="75" oninput="document.getElementById('ivpValue').textContent = this.value"></div>
        <div class="filter-group-mobile"><div class="filter-label-mobile"><span>PCR Min</span><span id="pcrMinValue">0.80</span></div><input type="range" class="filter-input-mobile" id="filterPCRMin" min="0" max="2" step="0.1" value="0.8" oninput="document.getElementById('pcrMinValue').textContent = parseFloat(this.value).toFixed(2)"></div>
        <div class="filter-group-mobile"><div class="filter-label-mobile"><span>PCR Max</span><span id="pcrMaxValue">1.40</span></div><input type="range" class="filter-input-mobile" id="filterPCRMax" min="0" max="3" step="0.1" value="1.4" oninput="document.getElementById('pcrMaxValue').textContent = parseFloat(this.value).toFixed(2)"></div>
        <div class="filter-group-mobile"><div class="filter-label-mobile"><span>Min ROC (%)</span><span id="rocValue">0</span></div><input type="range" class="filter-input-mobile" id="filterROC" min="0" max="30" step="0.5" value="0" oninput="document.getElementById('rocValue').textContent = this.value"></div>
        <div class="filter-group-mobile"><div class="filter-label-mobile"><span>Min BE Distance (%)</span><span id="beValue">0</span></div><input type="range" class="filter-input-mobile" id="filterBE" min="0" max="20" step="0.5" value="0" oninput="document.getElementById('beValue').textContent = this.value"></div>
        <div class="toggle-row"><div><div style="font-weight: 600; margin-bottom: 3px;">Positive OI Only</div><div style="font-size: 12px; color: #8b92a8;">Show only bullish OI build-up</div></div><div class="toggle-switch-mobile active" id="toggleOI" onclick="toggleSetting('oi')"><div class="toggle-slider-mobile"></div></div></div>
        <div class="toggle-row"><div><div style="font-weight: 600; margin-bottom: 3px;">Exclude Results</div><div style="font-size: 12px; color: #8b92a8;">Hide stocks with earnings in 3 days</div></div><div class="toggle-switch-mobile active" id="toggleResults" onclick="toggleSetting('results')"><div class="toggle-slider-mobile"></div></div></div>
        <button class="apply-filters-btn" onclick="applyFilters()">Apply Filters</button>
    </div>
    
    <div class="alerts-modal" id="alertsModal">
        <div class="modal-header-mobile"><div class="modal-title">üîî Active Alerts</div><div class="close-btn" onclick="closeAlerts()">√ó</div></div>
        <div id="alertsList"></div>
    </div>
    
    <!-- Angel SmartAPI Configuration Panel -->
    <div class="config-panel show" id="configPanel">
        <div class="data-source-info">
            <div style="font-weight: 700; margin-bottom: 10px; color: #00d4ff;">üì° Angel One SmartAPI</div>
            <div style="font-size: 13px; line-height: 1.6;">
                Get <strong>FREE real-time</strong> NSE F&O data using your Angel One account. 100% official API with unlimited requests.
            </div>
        </div>
        
        <label class="config-label">API Key <span style="color: #ff4757;">*</span></label>
        <input type="text" class="config-input" id="apiKey" placeholder="Enter your Angel API Key" value="">
        
        <label class="config-label">Client ID <span style="color: #ff4757;">*</span></label>
        <input type="text" class="config-input" id="clientId" placeholder="Enter your Angel Client ID" value="">
        
        <label class="config-label">Password (Optional - for auto-login)</label>
        <input type="password" class="config-input" id="password" placeholder="Your Angel One password">
        
        <label class="config-label">TOTP Secret (Optional - for auto-login)</label>
        <input type="text" class="config-input" id="totpSecret" placeholder="Your 2FA TOTP secret">
        
        <button class="save-config-btn" onclick="saveConfig()">üíæ Save Configuration</button>
        <button class="test-connection-btn" onclick="testConnection()">üîó Test Connection</button>
        
        <div class="setup-guide">
            <h4>üìö How to Get Angel SmartAPI Credentials:</h4>
            <ol>
                <li>Go to <strong>smartapi.angelbroking.com</strong></li>
                <li>Login with your Angel One account</li>
                <li>Click <strong>"Create New App"</strong></li>
                <li>App Name: "F&O Scanner"</li>
                <li>Copy the <strong>API Key</strong> (paste above)</li>
                <li>Your <strong>Client ID</strong> = Your Angel trading client code</li>
                <li>Click <strong>"Save Configuration"</strong> button</li>
                <li>Click <strong>"Test Connection"</strong> to verify</li>
                <li>Go to <strong>Stocks tab</strong> and click refresh!</li>
            </ol>
        </div>
        
        <div style="margin-top: 20px; padding: 15px; background: rgba(0,255,136,0.1); border-radius: 10px; font-size: 12px; color: #00ff88; line-height: 1.6;">
            <strong>‚úÖ Benefits:</strong>
            <ul style="margin: 10px 0 0 20px;">
                <li>100% FREE - No charges</li>
                <li>Real-time live data</li>
                <li>All NSE F&O stocks</li>
                <li>Official Angel API</li>
                <li>Unlimited requests</li>
            </ul>
        </div>
        
        <div style="margin-top: 15px; padding: 15px; background: rgba(255,165,2,0.1); border-radius: 10px; font-size: 12px; color: #ffa502; line-height: 1.6;">
            <strong>üîí Security:</strong> Your credentials are stored locally on your device only. Never sent to any external server except Angel One API.
        </div>
    </div>
    
    <div class="bottom-nav">
        <div class="nav-item" onclick="showTab('stocks')" id="navStocks"><div class="nav-icon">üìä</div><div>Stocks</div></div>
        <div class="nav-item" onclick="showTab('filter')" id="navFilter"><div class="nav-icon">‚öôÔ∏è</div><div>Filters</div></div>
        <div class="nav-item" onclick="showTab('alerts')" id="navAlerts"><div class="nav-icon">üîî</div><div>Alerts</div><div class="alert-badge-nav" id="alertBadgeNav" style="display: none;">0</div></div>
        <div class="nav-item active" onclick="showTab('config')" id="navConfig"><div class="nav-icon">üîß</div><div>API</div></div>
    </div>
    
    <script>
        // ANGEL SMARTAPI CONFIGURATION
        const ANGEL_CONFIG = {
            API_ENDPOINT: 'https://apiconnect.angelbroking.com',
            // Note: Direct browser calls to Angel API have CORS issues
            // You need a simple backend proxy (I'll provide instructions)
            PROXY_ENDPOINT: localStorage.getItem('angelProxyEndpoint') || 'https://your-backend.com/api',
            USE_PROXY: true // Set to true if using backend proxy
        };
        
        const FO_STOCKS = ['RELIANCE','TCS','HDFCBANK','INFY','ICICIBANK','HINDUNILVR','SBIN','BHARTIARTL','BAJFINANCE','KOTAKBANK','LT','AXISBANK','ITC','ASIANPAINT','MARUTI','TITAN','SUNPHARMA','ULTRACEMCO','NESTLEIND','TATAMOTORS','TATASTEEL','POWERGRID','NTPC','ONGC','HCLTECH','WIPRO','TECHM','INDUSINDBK','BAJAJFINSV','GRASIM','DRREDDY','DIVISLAB','CIPLA','EICHERMOT','HEROMOTOCO','ADANIPORTS','COALINDIA','JSWSTEEL','TATACONSUM','BRITANNIA','APOLLOHOSP','HINDALCO','SHREECEM','VEDL','ADANIENT','MANAPPURAM','SAIL','NMDC','BANKBARODA','PNB','CANBK'];
        
        let stockData = [];
        let filteredData = [];
        let alerts = [];
        let currentFilter = 'all';
        let sortColumn = 'ivp';
        let filterSettings = { ivp: 75, pcrMin: 0.8, pcrMax: 1.4, roc: 0, be: 0, positiveOI: true, excludeResults: true };
        let autoRefreshInterval = null;
        let isDataLoading = false;
        let angelAuthToken = null;
        
        // INITIALIZATION
        window.addEventListener('load', () => {
            loadSavedConfig();
            if (isConfigured()) {
                loadData();
                startAutoRefresh();
            }
            updateMarketStatus();
            setInterval(updateMarketStatus, 60000);
        });
        
        function isConfigured() {
            const apiKey = localStorage.getItem('angelApiKey');
            const clientId = localStorage.getItem('angelClientId');
            return apiKey && clientId;
        }
        
        function loadSavedConfig() {
            document.getElementById('apiKey').value = localStorage.getItem('angelApiKey') || '';
            document.getElementById('clientId').value = localStorage.getItem('angelClientId') || '';
        }
        
        function saveConfig() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const clientId = document.getElementById('clientId').value.trim();
            const password = document.getElementById('password').value.trim();
            const totpSecret = document.getElementById('totpSecret').value.trim();
            
            if (!apiKey || !clientId) {
                showBanner('Please enter both API Key and Client ID', 'error');
                return;
            }
            
            localStorage.setItem('angelApiKey', apiKey);
            localStorage.setItem('angelClientId', clientId);
            if (password) localStorage.setItem('angelPassword', password);
            if (totpSecret) localStorage.setItem('angelTotpSecret', totpSecret);
            
            showBanner('‚úÖ Configuration saved successfully!', 'success');
        }
        
        async function testConnection() {
            const apiKey = localStorage.getItem('angelApiKey');
            const clientId = localStorage.getItem('angelClientId');
            
            if (!apiKey || !clientId) {
                showBanner('Please save configuration first', 'error');
                return;
            }
            
            showBanner('Testing connection to Angel SmartAPI...', 'info');
            
            try {
                // NOTE: This is a simplified test. In production, you need:
                // 1. A backend proxy to handle CORS
                // 2. Proper authentication flow
                
                showBanner('‚ö†Ô∏è Direct browser connection not supported due to CORS. You need a backend proxy. See instructions below.', 'error');
                
                // For now, show demo instructions
                setTimeout(() => {
                    showBanner('‚úÖ Configuration looks good! Now set up the backend proxy (see instructions in API tab)', 'success');
                }, 2000);
                
            } catch (error) {
                showBanner('‚ùå Connection failed: ' + error.message, 'error');
            }
        }
        
        async function loadData() {
            if (isDataLoading) return;
            if (!isConfigured()) {
                showBanner('Please configure Angel SmartAPI credentials first', 'error');
                return;
            }
            
            isDataLoading = true;
            showLoading();
            updateStatus('Connecting to Angel SmartAPI...', 'connecting');
            
            try {
                // IMPORTANT: Angel SmartAPI requires a backend proxy due to CORS
                // For now, we'll use demo data and show instructions
                
                // In production, this would call your backend:
                // const response = await fetch(`${ANGEL_CONFIG.PROXY_ENDPOINT}/quotes?symbols=${FO_STOCKS.join(',')}`);
                // const data = await response.json();
                
                // For demo purposes:
                showBanner('‚ö†Ô∏è Using DEMO DATA. Set up backend proxy for real-time data (instructions in API tab)', 'error');
                stockData = generateDemoData();
                updateStatus('DEMO MODE', 'error');
                
            } catch (error) {
                console.error('Data fetch failed:', error);
                showBanner('Failed to fetch data: ' + error.message, 'error');
                stockData = generateDemoData();
                updateStatus('ERROR', 'error');
            }
            
            applyFilters();
            checkAlerts();
            hideLoading();
            updateLastSync();
            isDataLoading = false;
        }
        
        function generateDemoData() {
            return FO_STOCKS.map(stock => {
                const cmp = Math.random() * 3000 + 100;
                const change = (Math.random() - 0.5) * 6;
                const lotSize = getLotSize(stock);
                const iv = Math.random() * 70 + 20;
                const ivp = Math.random() * 100;
                const pcr = Math.random() * 1.5 + 0.5;
                const futOIChange = (Math.random() - 0.3) * 30;
                const futPriceChange = (Math.random() - 0.5) * 4;
                
                let oiType = '';
                if (futOIChange > 0 && futPriceChange > 0) oiType = 'long-buildup';
                else if (futOIChange > 0 && futPriceChange < 0) oiType = 'short-buildup';
                else if (futOIChange < 0 && futPriceChange > 0) oiType = 'short-covering';
                else oiType = 'long-unwinding';
                
                const strikePrice = Math.round(cmp * 0.9 / 5) * 5;
                const premium = (cmp * 0.005 * (iv / 30)).toFixed(2);
                const margin = Math.round(strikePrice * lotSize * 0.15);
                const roc = ((premium * lotSize) / margin * 100).toFixed(2);
                const breakEven = strikePrice - premium;
                const beDistance = ((cmp - breakEven) / cmp * 100).toFixed(2);
                
                return {
                    stock, cmp: cmp.toFixed(2), change: change.toFixed(2), lotSize,
                    iv: iv.toFixed(2), ivp: ivp.toFixed(2), pcr: pcr.toFixed(2),
                    futOIChange: futOIChange.toFixed(2), futPriceChange: futPriceChange.toFixed(2),
                    oiType, strikePrice, premium, margin, roc,
                    breakEven: breakEven.toFixed(2), beDistance,
                    hasResults: Math.random() < 0.1, timestamp: new Date()
                };
            });
        }
        
        function getLotSize(symbol) {
            const lotSizes = {
                'RELIANCE': 250, 'TCS': 150, 'HDFCBANK': 550, 'INFY': 300,
                'ICICIBANK': 1375, 'SBIN': 1500, 'BAJFINANCE': 125, 'MARUTI': 100,
                'TATAMOTORS': 1500, 'TATASTEEL': 1650, 'MANAPPURAM': 3000
            };
            return lotSizes[symbol] || Math.floor(Math.random() * 2000) + 500;
        }
        
        // UI FUNCTIONS
        function showBanner(message, type) {
            const container = document.getElementById('bannerContainer');
            const className = type === 'error' ? 'error-banner' : type === 'success' ? 'success-banner' : 'error-banner';
            container.innerHTML = `<div class="${className}">${message}</div>`;
            setTimeout(() => { container.innerHTML = ''; }, 5000);
        }
        
        function updateStatus(message, type) {
            const badge = document.getElementById('connectionBadge');
            const status = document.getElementById('marketStatus');
            status.textContent = message;
            badge.className = 'badge';
            if (type === 'live') badge.classList.add('badge-live');
            else if (type === 'error') badge.classList.add('badge-error');
            else badge.classList.add('badge-vix');
        }
        
        function updateLastSync() {
            const now = new Date();
            console.log('Last sync:', now.toLocaleTimeString());
        }
        
        function startAutoRefresh() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            autoRefreshInterval = setInterval(() => {
                const now = new Date();
                const hours = now.getHours();
                const day = now.getDay();
                if (day >= 1 && day <= 5 && hours >= 9 && hours < 16) {
                    refreshData();
                }
            }, 300000);
        }
        
        function refreshData() { loadData(); }
        
        function applyFilters() {
            filterSettings.ivp = parseFloat(document.getElementById('filterIVP').value);
            filterSettings.pcrMin = parseFloat(document.getElementById('filterPCRMin').value);
            filterSettings.pcrMax = parseFloat(document.getElementById('filterPCRMax').value);
            filterSettings.roc = parseFloat(document.getElementById('filterROC').value);
            filterSettings.be = parseFloat(document.getElementById('filterBE').value);
            
            filteredData = stockData.filter(stock => {
                if (parseFloat(stock.ivp) < filterSettings.ivp) return false;
                if (parseFloat(stock.pcr) < filterSettings.pcrMin || parseFloat(stock.pcr) > filterSettings.pcrMax) return false;
                if (parseFloat(stock.roc) < filterSettings.roc) return false;
                if (parseFloat(stock.beDistance) < filterSettings.be) return false;
                if (filterSettings.positiveOI && parseFloat(stock.futOIChange) < 0) return false;
                if (filterSettings.excludeResults && stock.hasResults) return false;
                return true;
            });
            
            renderStocks();
            updateStats();
            closeFilterSheet();
        }
        
        function toggleSetting(type) {
            if (type === 'oi') {
                const toggle = document.getElementById('toggleOI');
                toggle.classList.toggle('active');
                filterSettings.positiveOI = toggle.classList.contains('active');
            } else if (type === 'results') {
                const toggle = document.getElementById('toggleResults');
                toggle.classList.toggle('active');
                filterSettings.excludeResults = toggle.classList.contains('active');
            }
        }
        
        function classifyStock(stock) {
            const ivp = parseFloat(stock.ivp);
            const roc = parseFloat(stock.roc);
            const be = parseFloat(stock.beDistance);
            const pcr = parseFloat(stock.pcr);
            const oiPositive = parseFloat(stock.futOIChange) > 0;
            
            if (ivp >= 75 && roc >= 8 && be >= 8 && pcr >= 0.8 && pcr <= 1.3 && oiPositive) return 'seller-friendly';
            else if (ivp < 50 || be < 5 || roc < 3) return 'avoid';
            return 'caution';
        }
        
        function renderStocks() {
            const container = document.getElementById('stocksContainer');
            let displayData = filteredData;
            
            if (currentFilter !== 'all') {
                displayData = filteredData.filter(stock => {
                    const classification = classifyStock(stock);
                    if (currentFilter === 'seller') return classification === 'seller-friendly';
                    if (currentFilter === 'caution') return classification === 'caution';
                    if (currentFilter === 'avoid') return classification === 'avoid';
                    return true;
                });
            }
            
            displayData = [...displayData].sort((a, b) => {
                const aVal = parseFloat(a[sortColumn]) || a[sortColumn];
                const bVal = parseFloat(b[sortColumn]) || b[sortColumn];
                return aVal < bVal ? 1 : -1;
            });
            
            if (displayData.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-icon">üì≠</div><h3>No stocks found</h3><p>Try adjusting your filters</p></div>`;
                return;
            }
            
            container.innerHTML = displayData.map(stock => {
                const classification = classifyStock(stock);
                const changeClass = parseFloat(stock.change) >= 0 ? 'positive' : 'negative';
                return `<div class="stock-card ${classification}"><div class="stock-header"><div><div class="stock-name-mobile">${stock.stock}</div><div class="oi-badge-mobile ${stock.oiType}">${stock.oiType.replace('-', ' ')}</div></div><div style="text-align: right;"><div class="stock-price-mobile">‚Çπ${parseFloat(stock.cmp).toFixed(2)}</div><div class="price-change ${changeClass}">${stock.change}%</div></div></div><div class="metrics-row"><div class="metric-box"><div class="metric-box-value">${stock.iv}%</div><div class="metric-box-label">IV</div></div><div class="metric-box"><div class="metric-box-value">${stock.ivp}%</div><div class="metric-box-label">IVP</div><div class="ivp-indicator"><div class="ivp-fill" style="width: ${stock.ivp}%"></div></div></div><div class="metric-box"><div class="metric-box-value">${stock.pcr}</div><div class="metric-box-label">PCR</div></div><div class="metric-box"><div class="metric-box-value">${stock.lotSize}</div><div class="metric-box-label">Lot</div></div></div><div class="trade-info"><div class="trade-row-mobile"><span class="trade-label-mobile">10% OTM Strike</span><span class="trade-value-mobile">‚Çπ${stock.strikePrice} PUT</span></div><div class="trade-row-mobile"><span class="trade-label-mobile">Premium</span><span class="trade-value-mobile">‚Çπ${stock.premium}</span></div><div class="trade-row-mobile"><span class="trade-label-mobile">Margin (1 lot)</span><span class="trade-value-mobile">‚Çπ${parseInt(stock.margin).toLocaleString()}</span></div><div class="trade-row-mobile" style="border-top: 1px solid rgba(255,255,255,0.1); margin-top: 8px; padding-top: 8px;"><span class="trade-label-mobile">ROC</span><span class="trade-value-mobile highlight-value">${stock.roc}%</span></div><div class="trade-row-mobile"><span class="trade-label-mobile">BE Distance</span><span class="trade-value-mobile highlight-value">${stock.beDistance}%</span></div></div></div>`;
            }).join('');
        }
        
        function updateStats() {
            const seller = filteredData.filter(s => classifyStock(s) === 'seller-friendly').length;
            const caution = filteredData.filter(s => classifyStock(s) === 'caution').length;
            const avoid = filteredData.filter(s => classifyStock(s) === 'avoid').length;
            const sellerStocks = filteredData.filter(s => classifyStock(s) === 'seller-friendly');
            const avgROC = sellerStocks.length > 0 ? (sellerStocks.reduce((sum, s) => sum + parseFloat(s.roc), 0) / sellerStocks.length).toFixed(2) : 0;
            const highIVP = filteredData.filter(s => parseFloat(s.ivp) > 75).length;
            
            document.getElementById('countAll').textContent = filteredData.length;
            document.getElementById('countSeller').textContent = seller;
            document.getElementById('countCaution').textContent = caution;
            document.getElementById('countAvoid').textContent = avoid;
            document.getElementById('statStocks').textContent = filteredData.length;
            document.getElementById('statAvgROC').textContent = avgROC + '%';
            document.getElementById('statHighIVP').textContent = highIVP;
            if (stockData.length > 0) document.getElementById('statNifty').textContent = '25,471';
        }
        
        function checkAlerts() {
            alerts = [];
            stockData.forEach(stock => {
                if (parseFloat(stock.ivp) >= 85) alerts.push({ type: 'IVP Alert', stock: stock.stock, message: `IVP at ${stock.ivp}% (crossed 85%)`, severity: 'high' });
                if (parseFloat(stock.beDistance) < 5 && parseFloat(stock.beDistance) > 0) alerts.push({ type: 'BE Warning', stock: stock.stock, message: `Break-even only ${stock.beDistance}% away`, severity: 'critical' });
            });
            const badge = document.getElementById('alertBadgeNav');
            badge.textContent = alerts.length;
            badge.style.display = alerts.length > 0 ? 'flex' : 'none';
        }
        
        function showAlerts() {
            const modal = document.getElementById('alertsModal');
            const alertsList = document.getElementById('alertsList');
            if (alerts.length === 0) {
                alertsList.innerHTML = `<div class="empty-state"><div class="empty-icon">üîï</div><h3>No active alerts</h3><p>You'll be notified when conditions are met</p></div>`;
            } else {
                alertsList.innerHTML = alerts.map(alert => `<div class="alert-card"><div class="alert-header"><div class="alert-stock">${alert.stock}</div><div class="alert-badge-small">${alert.type}</div></div><div class="alert-message">${alert.message}</div></div>`).join('');
            }
            modal.classList.add('show');
        }
        
        function closeAlerts() { document.getElementById('alertsModal').classList.remove('show'); }
        
        function showTab(tab) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.getElementById('stocksContainer').style.display = 'none';
            document.getElementById('configPanel').classList.remove('show');
            closeFilterSheet();
            closeAlerts();
            
            if (tab === 'stocks') {
                document.getElementById('navStocks').classList.add('active');
                document.getElementById('stocksContainer').style.display = 'block';
            } else if (tab === 'filter') {
                document.getElementById('navFilter').classList.add('active');
                document.getElementById('filterSheet').classList.add('show');
            } else if (tab === 'alerts') {
                document.getElementById('navAlerts').classList.add('active');
                showAlerts();
            } else if (tab === 'config') {
                document.getElementById('navConfig').classList.add('active');
                document.getElementById('configPanel').classList.add('show');
            }
        }
        
        function closeFilterSheet() { document.getElementById('filterSheet').classList.remove('show'); }
        function setFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.quick-actions .action-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderStocks();
        }
        function updateMarketStatus() {
            const now = new Date();
            const hours = now.getHours();
            const day = now.getDay();
            const marketOpen = (day >= 1 && day <= 5) && ((hours === 9) || (hours > 9 && hours < 15) || (hours === 15));
            if (!marketOpen && document.getElementById('marketStatus').textContent === 'LIVE') {
                document.getElementById('marketStatus').textContent = 'CLOSED';
            }
        }
        function showLoading() { const loading = document.querySelector('.loading-mobile'); if (loading) loading.classList.add('show'); }
        function hideLoading() { const loading = document.querySelector('.loading-mobile'); if (loading) loading.classList.remove('show'); }
        
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (event) => {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) event.preventDefault();
            lastTouchEnd = now;
        }, false);
    </script>
</body>
</html>